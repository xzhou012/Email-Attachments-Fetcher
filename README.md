# Email Attachment Downloader

This project downloads attachments from a designated email folder with flexible search range options and comprehensive configuration tools.
Please be advised that this project is mainly generated by Cursor.

## Features

- **Email Integration**: Connects to various email providers (Gmail, Outlook, Yahoo, QQ Mail, 163 Mail, Wangyi Corporate Mail)
- **Attachment Download**: Downloads all attachments from a specified email folder
- **File Type Filtering**: Can filter downloads by file type (e.g., .xls, .xlsx, .pdf)
- **Search Range Options**: Multiple ways to limit which emails are processed:
  - All emails (default)
  - Date range filtering (YYYYMMDD format)
  - Count limit (process only N emails)
  - Recent days (last N days)
- **Interactive Menu System**: User-friendly menu with multiple configuration options
- **Email Access Verification**: Built-in testing to verify email credentials and connectivity
- **Folder Selection**: Interactive folder selection from available email folders
- **Safe Filename Handling**: Automatically handles special characters in filenames
- **Batch Processing**: Processes emails in manageable chunks to optimize memory usage
- **UTF-8 Support**: Properly handles Chinese and other international characters
- **Robust Configuration**: Automatic saving of settings with error handling
- **Duplicate Detection**: Skips existing files to avoid re-downloading

## Setup

### 1. Install Dependencies

```bash
pip install -r requirements.txt
```

### 2. Configure Email Settings

Edit `email_config.py` and update the following settings:

```python
EMAIL_SETTINGS = {
    "email_address": "your_email@gmail.com",  # Replace with your email
    "password": None,  # Will prompt for password if None
    "folder_name": "INBOX",  # Email folder to search
    "download_path": "./files",  # Path to save attachments
    "file_types": ['.xls', '.xlsx'],  # File types to download
    "search_range": {
        "enabled": False,  # Set to True to use search range
        "type": "all",  # Options: "all", "date_range", "count_limit", "recent_days"
        "date_range": {
            "start_date": "20240101",  # Format: YYYYMMDD
            "end_date": "20241231"     # Format: YYYYMMDD
        },
        "count_limit": 100,  # Maximum number of emails to process
        "recent_days": 30,   # Process emails from last N days
        "batch_size": 50     # Number of emails to process in each batch
    }
}
```

### 3. Email Provider Configuration

The script supports multiple email providers. Update `DEFAULT_CONFIG` in `email_config.py`:

- **Gmail**: `DEFAULT_CONFIG = GMAIL_CONFIG`
- **Outlook/Hotmail**: `DEFAULT_CONFIG = OUTLOOK_CONFIG`
- **Yahoo**: `DEFAULT_CONFIG = YAHOO_CONFIG`
- **QQ Mail**: `DEFAULT_CONFIG = QQ_CONFIG`
- **163 Mail**: `DEFAULT_CONFIG = MAIL163_CONFIG`
- **Wangyi Corporate Mail**: `DEFAULT_CONFIG = WANGYI_CONFIG`

### 4. Environment Variables (Optional)

Create a `credentials.env` file for secure credential storage:

```env
email_address=your_email@domain.com
password=your_password
folder_name=INBOX
```

### 5. Gmail App Password (Recommended)

For Gmail, it's recommended to use an App Password instead of your regular password:

1. Enable 2-Factor Authentication on your Google account
2. Go to Google Account Settings > Security > App Passwords
3. Generate an app password for "Mail"
4. Use this app password in the configuration

## Usage

### Main Script with Interactive Menu (Recommended)

Run the main script which provides a comprehensive menu system:

```bash
python main.py
```

This will show a menu with the following options:

1. **Download attachments** - Download email attachments
2. **Configure search settings** - Set up search range options
3. **Configure folder settings** - Choose which folder to search
4. **Test email access** - Verify email credentials and connectivity
5. **Show current configuration** - Display current settings
6. **Exit** - Quit the program

### Standalone Configuration Tool (Alternative)

If you prefer a standalone configuration tool:

```bash
python configure_search.py
```

This provides the same search configuration options but as a separate script.

### Menu Options Explained

#### Option 1: Download Attachments
- Downloads attachments based on your current configuration
- Automatically checks email access before proceeding
- Shows progress and results
- Handles errors gracefully

#### Option 2: Configure Search Settings
Interactive configuration for search ranges:
- **All emails**: Download all emails in the folder
- **Date range**: Specify start and end dates (YYYYMMDD format)
- **Count limit**: Process only the first N emails
- **Recent days**: Download emails from the last N days
- **Batch size**: Configure how many emails to process at once

#### Option 3: Configure Folder Settings
- Connects to your email and lists all available folders
- Shows current folder with a marker
- Allows selection by number or manual entry
- Validates folder existence

#### Option 4: Test Email Access
Comprehensive email connectivity test:
- Verifies email credentials
- Tests IMAP connection
- Lists available folders
- Checks target folder accessibility
- Shows email count in target folder

#### Option 5: Show Current Configuration
Displays current settings:
- Target folder
- Search range settings
- File type filters
- Batch processing settings

### Advanced Troubleshooting

The main script includes built-in email access testing (Option 4: Test email access) which provides comprehensive diagnostics:

- Email credential verification
- IMAP connection testing
- Folder accessibility checks
- Email count verification

If you need more detailed troubleshooting, you can also use the standalone configuration tool:

```bash
python configure_search.py
```

## Search Range Options

### 1. All Emails (Default)
Downloads all emails in the specified folder:
```python
"search_range": {
    "enabled": False,
    "type": "all"
}
```

### 2. Date Range
Download emails within a specific date range (YYYYMMDD format):
```python
"search_range": {
    "enabled": True,
    "type": "date_range",
    "date_range": {
        "start_date": "20240101",
        "end_date": "20241231"
    }
}
```

**Date Format**: Use YYYYMMDD format (e.g., 20240101 for January 1, 2024)

### 3. Count Limit
Download only the first N emails:
```python
"search_range": {
    "enabled": True,
    "type": "count_limit",
    "count_limit": 50
}
```

### 4. Recent Days
Download emails from the last N days:
```python
"search_range": {
    "enabled": True,
    "type": "recent_days",
    "recent_days": 7
}
```

## Batch Processing

The script uses batch processing to optimize performance and memory usage:

- **Default batch size**: 50 emails per batch
- **Configurable**: Can be adjusted based on your system capabilities
- **Memory efficient**: Processes emails in smaller chunks
- **Progress tracking**: Shows progress for each batch
- **Error recovery**: If one batch fails, others continue

### Recommended Batch Sizes:
- **Fast connection, powerful system**: 100-200 emails
- **Standard setup**: 50 emails (default)
- **Slow connection or limited memory**: 10-25 emails

## File Structure

```
project/
├── email_downloader.py      # Core email downloading functionality
├── email_config.py          # Email configuration settings
├── main.py                  # Main script with interactive menu system
├── configure_search.py      # Standalone search configuration tool
├── requirements.txt         # Python dependencies
├── .gitignore              # Git ignore file for security
├── README.md               # This file
├── credentials.env         # Email credentials (optional)
└── files/                  # Directory where attachments are downloaded
    └── (downloaded files)
```

## Output

The script downloads attachments to the specified directory (default: `./files/`) and provides:

- **Progress tracking** during download
- **Summary of downloaded files**
- **Error handling** for failed downloads
- **Duplicate file detection** (skips existing files)
- **Detailed logging** of operations
- **Batch completion status**

## Troubleshooting

### Connection Issues

1. **Gmail**: Make sure to use an App Password if 2FA is enabled
2. **Outlook**: Check if IMAP is enabled in your account settings
3. **Wangyi Corporate Mail**: Verify IMAP settings in your email client
4. **Other providers**: Verify IMAP settings in your email client

### Download Issues

1. **No files downloaded**: 
   - Use "Test email access" option (Menu Option 4) to verify connectivity
   - Check if emails have attachments
   - Verify file type filters
   - Use the standalone configuration tool for additional diagnostics

2. **Partial downloads**:
   - Check search range settings
   - Verify folder name is correct
   - Check batch size settings
   - Ensure sufficient disk space

3. **Date range not working**:
   - Ensure dates are in YYYYMMDD format
   - Check that start date is before end date
   - Verify emails exist in the specified date range
   - Try a wider date range first

4. **Encoding errors**:
   - The script handles UTF-8 and Chinese encodings automatically
   - If issues persist, check email content encoding

5. **Memory issues**:
   - Reduce batch size
   - Use count limits instead of processing all emails
   - Close other applications to free memory

### Common Errors

- **"Authentication failed"**: Check your email and password
- **"Folder not found"**: Use folder configuration option to select correct folder
- **"No files downloaded"**: Check if emails in the folder have attachments
- **"UTF-8 decode error"**: The script should handle this automatically
- **"Connection timeout"**: Check network connection and try smaller batch sizes

## Security Notes

- Never commit your email password to version control
- Use App Passwords when possible
- The script prompts for password if not provided in config
- Downloaded files are saved locally - ensure proper file permissions
- Use `credentials.env` for secure credential storage
- The `.gitignore` file prevents sensitive files from being committed

## Customization

### Adding New Email Providers

Add new configurations to `email_config.py`:

```python
NEW_PROVIDER_CONFIG = {
    "imap_server": "imap.newprovider.com",
    "imap_port": 993,
    "smtp_server": "smtp.newprovider.com",
    "smtp_port": 587
}
```

### Modifying File Type Filters

Edit the `file_types` list in `email_config.py`:

```python
"file_types": ['.xls', '.xlsx', '.pdf', '.doc', '.docx']
```

### Adjusting Batch Sizes

For large email folders, adjust the batch size:

```python
"batch_size": 25  # Smaller batches for slower connections
```

## Performance Tips

- **Large folders**: Use count limits or date ranges to avoid processing too many emails
- **Slow connections**: Reduce batch size for better stability
- **Memory usage**: The script processes emails in batches to minimize memory usage
- **Duplicate files**: The script skips existing files to avoid re-downloading
- **Date ranges**: Use specific date ranges to limit processing time
- **Regular backups**: Keep your credentials.env file backed up securely

## Recent Updates

### Version 2.0 Features
- **Interactive Menu System**: User-friendly menu with multiple options
- **Email Access Verification**: Built-in testing for credentials and connectivity
- **Folder Selection**: Interactive folder selection from available folders
- **Improved Date Handling**: YYYYMMDD format with automatic IMAP conversion
- **Robust Configuration**: Automatic saving with error handling
- **Enhanced Error Reporting**: Detailed error messages and troubleshooting tips
- **Batch Processing Optimization**: Improved memory management and performance
- **Duplicate File Detection**: Prevents re-downloading existing files

## License

This project is for educational and personal use. Please respect email service terms of use. 